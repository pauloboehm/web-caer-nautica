<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualizador de Rotas com Barcos</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; }
  canvas { border: 1px solid black; margin-top: 10px; display: block; }
  #info { margin-top: 10px; font-size: 16px; line-height: 1.4; }
</style>
</head>
<body>

<h2>Visualizador de Rotas com Barcos</h2>

<canvas id="mapCanvas"></canvas>
<div id="info"></div>

<script src="firedb.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

window.firebase_app = initializeApp(firebaseConfig);
const db = getDatabase(window.firebase_app);

const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

const mapaAtual = { arquivo: "semmapa.png", minLat:0, maxLat:1, minLon:0, maxLon:1 };
const img = new Image();
img.src = mapaAtual.arquivo;

function ajustarCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerWidth*0.6;
  if(img.complete) desenharRotas();
}
window.addEventListener("load", ajustarCanvas);
window.addEventListener("resize", ajustarCanvas);

function gpsParaCanvas(lat,lon){
  const {minLat,maxLat,minLon,maxLon} = mapaAtual;
  const x = (lon-minLon)/(maxLon-minLon)*canvas.width;
  const y = canvas.height - (lat-minLat)/(maxLat-minLat)*canvas.height;
  return {x,y};
}

// Rotas e cores
const rotas = {}; 
const cores = {}; 
const MAX_PONTOS = 600; 

function gerarCor(uid){
  if(!cores[uid]){
    cores[uid] = `hsl(${Math.floor(Math.random()*360)}, 80%, 50%)`;
  }
  return cores[uid];
}

// Desenha tri√¢ngulo representando o barco
function desenharBarco(x, y, heading, cor){
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate((heading||0) * Math.PI / 180); // heading em graus ‚Üí rad
  ctx.beginPath();
  ctx.moveTo(0, -8);   // ponta do barco
  ctx.lineTo(5, 5);    // lado direito
  ctx.lineTo(-5, 5);   // lado esquerdo
  ctx.closePath();
  ctx.fillStyle = cor;
  ctx.fill();
  ctx.restore();
}

// Desenha todas as rotas e barcos
function desenharRotas(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);

  for(const uid in rotas){
    const cor = gerarCor(uid);
    for(const rotaId in rotas[uid]){
      let pontos = rotas[uid][rotaId];
      if(pontos.length<2) continue;
      if(pontos.length > MAX_PONTOS){
        pontos = pontos.slice(-MAX_PONTOS);
      }

      // Tra√ßo da rota
      ctx.beginPath();
      const inicio = gpsParaCanvas(pontos[0].lat,pontos[0].lon);
      ctx.moveTo(inicio.x,inicio.y);
      for(let i=1;i<pontos.length;i++){
        const p = gpsParaCanvas(pontos[i].lat,pontos[i].lon);
        ctx.lineTo(p.x,p.y);
      }
      ctx.strokeStyle = cor;
      ctx.lineWidth = 2;
      ctx.stroke();

      // √öltimo ponto como barco
      const ultimo = pontos[pontos.length-1];
      const {x, y} = gpsParaCanvas(ultimo.lat, ultimo.lon);
      desenharBarco(x, y, ultimo.heading, cor);
    }
  }

  // Lista usu√°rios
  info.innerHTML = Object.keys(rotas).map(uid => `<span style="color:${cores[uid]}">${uid}</span>`).join("<br>");
}

// üîπ Observa todas as rotas em tempo real
const rotasRef = ref(db, "rotas");

onChildAdded(rotasRef, snapshotUser=>{
  const uid = snapshotUser.key;
  rotas[uid] = {};

  onChildAdded(snapshotUser.ref, snapshotRota=>{
    const rotaId = snapshotRota.key;
    rotas[uid][rotaId] = [];

    const pontosRef = snapshotRota.ref.child("pontos");
    onChildAdded(pontosRef, snapshotPonto=>{
      rotas[uid][rotaId].push(snapshotPonto.val());
      if(rotas[uid][rotaId].length > MAX_PONTOS){
        rotas[uid][rotaId] = rotas[uid][rotaId].slice(-MAX_PONTOS);
      }
      desenharRotas();
    });
  });
});

img.onload = desenharRotas;
</script>
</body>
</html>
