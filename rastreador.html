<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gravador GPX com Mapa</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; }
  canvas { border: 1px solid black; margin-top: 10px; }
  #info { margin-top: 10px; font-size: 18px; line-height: 1.6; }
  #relogio { font-size: 20px; margin-top: 5px; font-weight: bold; }
  #mapCanvas { width: 100%; height: width; display: block; }
  @media (max-width: 600px) { /* Celular (largura até 600px) */
    body {
      font-size: 20px;
    }
    #info { font-size: 36px; line-height: 1.6; }
    #relogio { font-size: 40px; }
  }
</style>
</head>
<body>
  <script src="rastreio.js"></script>

  <h2>Gravador de Trilhas (GPX)</h2>

  <label for="mapSelect">Escolha o mapa:</label>
  <select id="mapSelect">
    <option value="mapaLocal">Mapa local</option>
  </select>
  <br><br>
  <label for="raio">Raio do mapa:</label>
  <select id="raio">
    <option value="2">2 km</option>
    <option value="5">5 km</option>
    <option value="10" selected>10 km</option>
    <option value="20">20 km</option>
    <option value="50">50 km</option>
  </select>
  <br><br>

  <button id="startBtn">Iniciar</button>
  <button id="stopBtn" disabled>Terminar</button>
  <label id="infoPrec">Precisão</label>
  <br>
  <canvas id="mapCanvas" width=max-content height=auto></canvas>

  <div id="relogio">--:--:--</div>
  <div id="info">
    Velocidade: 0 Mph<br>
    Rumo: -<br>
    Tempo: 0s<br>
    Distância: 0.0 km
  </div>

  <script>
    const canvas = document.getElementById("mapCanvas");
    const ctx = canvas.getContext("2d");
    const info = document.getElementById("info");

    window.addEventListener("load", ajustarCanvas);
    window.addEventListener("resize", ajustarCanvas);

    const img = new Image();
    let pontos = [];
    let intervalo = null;
    let inicioTempo = null;
    let distanciaTotal = 0;
    let raioMapa = 10;

    let wakeLock = null;

    // Configuração dos mapas
    let mapas = {}; // mapaAtual será definido depois
    let mapaAtual = null;

    async function carregarMapasJSON() {
      try {
        const response = await fetch("mapas.json");
        const dados = await response.json();
        const select = document.getElementById("mapSelect");
        dados.forEach(m => {
          mapas[m.id] = m;
          const option = document.createElement("option");
          option.value = m.id;
          option.textContent = m.nome;
          select.appendChild(option);
        });
        // Carrega o primeiro mapa por padrão
        //carregarMapa(dados[0].id);
      } catch (err) {
        console.error("Erro ao carregar mapas JSON:", err);
      }
    }

    function carregarMapa(mapa) {
      mapaAtual = mapas[mapa];
      img.src = mapaAtual.arquivo;
      img.onload = () => {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
    }

    // Conversão GPS → Canvas
    function gpsParaCanvas(lat, lon) {
      const {minLat, maxLat, minLon, maxLon} = mapaAtual;
      const x = (lon - minLon) / (maxLon - minLon) * canvas.width;
      const y = canvas.height - (lat - minLat) / (maxLat - minLat) * canvas.height;
      return {x, y};
    }

    function desenharPercurso() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      if (pontos.length < 2) return;

      ctx.beginPath();
      const inicio = gpsParaCanvas(pontos[0].lat, pontos[0].lon);
      ctx.moveTo(inicio.x, inicio.y);

      for (let i = 1; i < pontos.length; i++) {
        const p = gpsParaCanvas(pontos[i].lat, pontos[i].lon);
        ctx.lineTo(p.x, p.y);
      }

      ctx.strokeStyle = "red";
      ctx.lineWidth = 3;
      ctx.stroke();

      const ultimo = gpsParaCanvas(pontos[pontos.length-1].lat, pontos[pontos.length-1].lon);
      ctx.fillStyle = "blue";
      ctx.beginPath();
      ctx.arc(ultimo.x, ultimo.y, 5, 0, 2 * Math.PI);
      ctx.fill();
    }

    function atualizarInfo() {
      let vel_api = 0;
      let rumo_api = "-";
      let rumo_apiTxt = "-";

      if (pontos.length >= 2) {
        const p1 = pontos[pontos.length-2];
        const p2 = pontos[pontos.length-1];

        const dist = distanciaMetros(p1.lat, p1.lon, p2.lat, p2.lon);
        distanciaTotal += dist;

        if(p2.speed == null){
          const dt = (new Date(p2.time) - new Date(p1.time)) / 1000;
          const vel = dt > 0 ? (dist/dt) : 0;
          //velKmh = (vel * 3.6).toFixed(1);
          velMph = (vel * 2.23694).toFixed(1);
          vel_api = velMph;
        }else vel_api = (p2.speed * 2.23694).toFixed(1); //Converte de metros/segundo para mph
        if(p2.heading == null){
          rumo = calcularRumo(p1.lat, p1.lon, p2.lat, p2.lon).toFixed(0);
          rumo_api = rumo;
        }else rumo_api = p2.heading.toFixed(0);
        rumo_apiTxt = rumoCardinal(rumo_api);

        const accdisplay = document.getElementById("infoPrec");
        accdisplay.innerText = `Precisão: ${p2.accuracy.toFixed(2)} m`;
        if(p2.accuracy < 2.5) accdisplay.style.backgroundColor = "green";
        else if(p2.accuracy < 5) accdisplay.style.backgroundColor = "yellow";
        else accdisplay.style.backgroundColor = "red";
      }

      const tempoDecorrido = inicioTempo ? Math.floor((Date.now() - inicioTempo) / 1000) : 0;
      const horas = Math.floor(tempoDecorrido / 3600);
      const minutos = Math.floor((tempoDecorrido % 3600) / 60);
      const segundos = tempoDecorrido % 60;
      const tempoFmt = `${horas}h ${minutos}m ${segundos}s`;

      info.innerHTML = `
        Velocidade: ${vel_api} Mph<br>
        Rumo: ${rumo_api}° (${rumo_apiTxt})<br>
        Tempo: ${tempoFmt}<br>
        Distância: ${(distanciaTotal/1000).toFixed(2)} km
      `;
    }

    document.getElementById("raio").addEventListener("change", (e) => {
      raioMapa = parseInt(e.target.value);
      let mapsel = document.getElementById("mapSelect");
      if(mapsel.value == "mapaLocal") carregarMapaAtual();
      else carregarMapa(mapsel.value);
      desenharPercurso();
    });

    function gerarGPX(pontos) {
      const header = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="JS GPX Recorder" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>Rota</name><trkseg>`;
      const footer = `</trkseg></trk></gpx>`;

      const pts = pontos.map(p => 
        `<trkpt lat="${p.lat}" lon="${p.lon}">
          <time>${p.time}</time>
          <speed>${p.speed}</speed>
          <course>${p.heading}</course>
          <ele>${p.ele}</ele>
          <accuracy>${p.accuracy}</accuracy>
        </trkpt>`
      ).join("\n");

      return header + "\n" + pts + "\n" + footer;
    }

    async function ativarWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        console.log("Wake Lock ativo.");
        wakeLock.addEventListener("release", () => console.log("Wake Lock liberado!"));
      } catch (err) {
        console.error("Erro ao ativar Wake Lock:", err);
      }
    }

    async function desativarWakeLock() {
      if (wakeLock) await wakeLock.release();
      wakeLock = null;
    }

    document.getElementById("mapSelect").onchange = (e) => {
      carregarMapa(e.target.value);
    };

    document.getElementById("startBtn").onclick = () => {
      pontos = [];
      distanciaTotal = 0;
      inicioTempo = Date.now();

      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;

      ativarWakeLock();
      desenharPercurso();
      const opcao_pos = {
        enableHighAccuracy: true,
        timeout: 500,
        maximumAge: 0
      };
      intervalo = setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          pontos.push({
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            time: new Date().toISOString(),
            speed: pos.coords.speed,
            heading: pos.coords.heading,
            accuracy: pos.coords.accuracy,
            ele: pos.coords.altitude
          });
          desenharUltimoPonto();
          atualizarInfo();
        }, err => console.error("Erro ao obter localização:", err), opcao_pos);
      }, 1000);
    };

    document.getElementById("stopBtn").onclick = () => {
      clearInterval(intervalo);
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;

      desativarWakeLock();

      const gpx = gerarGPX(pontos);
      const blob = new Blob([gpx], { type: "application/gpx+xml" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "trilha.gpx";
      a.click();
      URL.revokeObjectURL(url);

      alert("Arquivo GPX gerado e baixado!");
    };

    // Relógio local
    function atualizarRelogio() {
      const agora = new Date();
      const horas = String(agora.getHours()).padStart(2,'0');
      const minutos = String(agora.getMinutes()).padStart(2,'0');
      const segundos = String(agora.getSeconds()).padStart(2,'0');
      document.getElementById("relogio").textContent = `${horas}:${minutos}:${segundos}`;
    }
    setInterval(atualizarRelogio, 1000);

    // Carrega mapa inicial
    carregarMapasJSON();
    carregarMapaAtual();
  </script>
</body>
