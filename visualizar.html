<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Monitoramento de Rotas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <style>
    #map { width: 100%; height: 90vh; }
    #btnCentralizar {
      margin: 10px;
      padding: 8px 12px;
      background: navy;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #btnCentralizar:hover {
      background: darkblue;
    }
  </style>
</head>
<body>
  <h2>‚õµ Monitoramento em tempo real</h2>
  <button id="btnCentralizar">üîç Centralizar nos competidores</button>
  <div id="map"></div>

  <script src="firedb.js"></script>

  <script>
    // üîπ Mapa
    const map = L.map('map').setView([-23.55, -46.63], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // üîπ √çcone de barco
    const barcoIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/77/77521.png",
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    // üîπ Competidores ativos no mapa
    const competidores = {}; 
    // { idCompetidor: { marker, polyline, ultimosPontos[], lastUpdate, color } }

    // Fun√ß√£o para gerar cor √∫nica a partir do id
    function colorFromId(id) {
      let hash = 0;
      for (let i = 0; i < id.length; i++) {
        hash = id.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = hash % 360;
      return `hsl(${hue}, 80%, 50%)`; // cor vibrante
    }

    // Escuta altera√ß√µes no n√≥ "rotas"
    db.ref("rotas").on("value", (snapshot) => {
      const rotas = snapshot.val() || {};

      Object.keys(rotas).forEach(dispositivo => {
        const trechos = rotas[dispositivo];
        Object.keys(trechos).forEach(trechoId => {
          const trecho = trechos[trechoId];
          if (!trecho || !trecho.pontos) return;

          const nome = trecho.nome || dispositivo;
          const pontos = Object.values(trecho.pontos);
          const ultimo = pontos[pontos.length - 1];

          if (!ultimo || !ultimo.lat || !ultimo.lon) return;

          const lat = ultimo.lat;
          const lon = ultimo.lon;
          const rumo = ultimo.rumo || 0;
          const timestamp = ultimo.timestamp || Date.now();

          const idCompetidor = dispositivo + "_" + trechoId;

          // cria se n√£o existir
          if (!competidores[idCompetidor]) {
            const cor = colorFromId(idCompetidor);
            competidores[idCompetidor] = {
              marker: L.marker([lat, lon], {
                icon: barcoIcon,
                rotationAngle: rumo,
                rotationOrigin: "center"
              }).addTo(map)
              .bindPopup(`<b>${nome}</b><br>Rumo: ${rumo}¬∞`)
              .bindTooltip(nome, { permanent: true, direction: "right", offset: [10,0] }),

              polyline: L.polyline([[lat, lon]], { color: cor, weight: 3 }).addTo(map),

              ultimosPontos: [{ lat, lon }],
              lastUpdate: timestamp,
              color: cor
            };
          } else {
            // atualiza posi√ß√£o e popup
            competidores[idCompetidor].marker.setLatLng([lat, lon]);
            competidores[idCompetidor].marker.setRotationAngle(rumo);
            competidores[idCompetidor].marker.setPopupContent(`<b>${nome}</b><br>Rumo: ${rumo}¬∞`);
            competidores[idCompetidor].marker.setTooltipContent(nome);

            // atualiza trilha
            competidores[idCompetidor].ultimosPontos.push({ lat, lon });
            if (competidores[idCompetidor].ultimosPontos.length > 300) {
              competidores[idCompetidor].ultimosPontos.shift();
            }
            const coords = competidores[idCompetidor].ultimosPontos.map(p => [p.lat, p.lon]);
            competidores[idCompetidor].polyline.setLatLngs(coords);

            // atualiza tempo
            competidores[idCompetidor].lastUpdate = timestamp;
          }
        });
      });
    });

    // üîπ Remove competidores inativos (>1 minuto sem atualiza√ß√£o)
    setInterval(() => {
      const agora = Date.now();
      Object.keys(competidores).forEach(id => {
        if (agora - competidores[id].lastUpdate > 60000) {
          map.removeLayer(competidores[id].marker);
          map.removeLayer(competidores[id].polyline);
          delete competidores[id];
        }
      });
    }, 10000);

    // üîπ Fun√ß√£o para centralizar
    function centralizarBarcos() {
      const coords = Object.values(competidores).map(c => c.marker.getLatLng());
      if (coords.length > 0) {
        const bounds = L.latLngBounds(coords);
        map.fitBounds(bounds.pad(0.2));
      }
    }

    document.getElementById("btnCentralizar").addEventListener("click", centralizarBarcos);
  </script>
</body>
</html>
